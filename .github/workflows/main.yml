# .github/workflows/build-and-push.yml
name: Build and Push Docker Image

on:
  push:
    branches: [ main ]
  # pull_request:
  #   branches: [ main ]
  schedule:
    - cron: '0 22 * * 0' # Every sunday at 2200Z

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  download-winget-apps:
    runs-on: windows-2025
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Update winget sources
      run: |
        winget source update
      shell: pwsh

    - name: Download installers with custom script
      run: |
        .\scripts\winget-downloader.ps1 -PackageListFile "pollen/winget-installers.txt" -DownloadDirectory "honey/winget-installers"
      shell: pwsh

    - name: Upload winget artifacts
      uses: actions/upload-artifact@v4
      with:
        name: winget-installers
        path: honey/winget-installers/

  build-and-push:
    runs-on: ubuntu-latest
    needs: download-winget-apps
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download winget artifacts
      uses: actions/download-artifact@v4
      with:
        name: winget-installers
        path: honey/winget-installers/

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install offvsix
      run: |
        pip install offvsix

    - name: Download files with offvsix
      run: |
        offvsix --file pollen/vscode-extensions.txt --destination honey/vscode-extensions/

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=raw,value=latest
          type=raw,value={{date 'YYYY' tz='UTC'}}-{{date 'WW' tz='UTC'}}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
